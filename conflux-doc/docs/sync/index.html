<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.73">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Conflux Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Conflux Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Conflux" href="/opensearch.xml"><title data-react-helmet="true">Block Synchronization Process | Conflux</title><meta data-react-helmet="true" property="og:url" content="https://developer.conflux-chain.org/conflux-doc/docs/sync"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Block Synchronization Process | Conflux"><meta data-react-helmet="true" name="description" content="Synchronization Graph"><meta data-react-helmet="true" property="og:description" content="Synchronization Graph"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://developer.conflux-chain.org/conflux-doc/docs/sync"><link data-react-helmet="true" rel="alternate" href="https://developer.conflux-chain.org/conflux-doc/docs/sync" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://developer.conflux-chain.org/conflux-doc/docs/sync" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://S86OJPVVGF-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.260e99e2.css">
<link rel="preload" href="/assets/js/styles.09d29aa9.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.fc3fe743.js" as="script">
<link rel="preload" href="/assets/js/main.048bb938.js" as="script">
<link rel="preload" href="/assets/js/1.d3ce46d4.js" as="script">
<link rel="preload" href="/assets/js/2.7790b6fc.js" as="script">
<link rel="preload" href="/assets/js/3.8961ff1e.js" as="script">
<link rel="preload" href="/assets/js/1be78505.764ef7d8.js" as="script">
<link rel="preload" href="/assets/js/114.2bb3ed4e.js" as="script">
<link rel="preload" href="/assets/js/935f2afb.100b377e.js" as="script">
<link rel="preload" href="/assets/js/17896441.5fa3fe54.js" as="script">
<link rel="preload" href="/assets/js/9296fd2d.f66c1b88.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Conflux Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Conflux Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Conflux Developer</strong></a><a class="navbar__item navbar__link" href="/guides/en/how_to_use_cfx_faucet">Guides</a><a class="navbar__item navbar__link" href="/">Core</a><a class="navbar__item navbar__link" href="/conflux-doc/docs/EVM-Space/intro_of_evm_space">eSpace</a><a class="navbar__item navbar__link" href="/conflux-doc/docs/json_rpc">APIs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/conflux-chain/conflux-rust" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Conflux Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Conflux Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Conflux Developer</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/guides/en/how_to_use_cfx_faucet">Guides</a></li><li class="menu__list-item"><a class="menu__link" href="/">Core</a></li><li class="menu__list-item"><a class="menu__link" href="/conflux-doc/docs/EVM-Space/intro_of_evm_space">eSpace</a></li><li class="menu__list-item"><a class="menu__link" href="/conflux-doc/docs/json_rpc">APIs</a></li><li class="menu__list-item"><a href="https://github.com/conflux-chain/conflux-rust" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Block Synchronization Process</h1></header><div class="markdown"><p>Synchronization Graph
Synchronization graph is designed to organize newly arrived blocks (received from the peers, loaded from local storage, or self-mined) even when their past blocks havenâ€™t been completely collected. Once all the past blocks of a block have been collected in synchronization graph, it will be dispatched to consensus graph for further processing.</p><p>The block header and block body enter the synchronization graph in separate processes, because, typically, the block header and body are transferred separately in peer-to-peer layer. The graph structure in the synchronization graph is constructed by block header arrival. Each block is represented as a node in the graph structure, and the nodes are linked through the parent/child and referrer/referee relations between blocks. </p><p>Synchronization graph checks the validity of arriving blocks. The blocks that do not pass the validity checks are invalid and will not be dispatched to consensus graph further. The following validity checks are conducted:</p><ol><li>Check whether the parent or referees of a block are invalid. If one of them is invalid, the block is invalid too. </li><li>Check whether the nonce in the block header is correctly set based on the difficulty in the block header, i.e., the miner of the block correctly solved the POW puzzle.</li><li>Check whether the number of referees in the block header is larger than a threshold (200). If so, the block is invalid.</li><li>Check whether there are duplicated hashes in the parent and referees of a block. If so, the block is invalid.</li><li>Check whether the length (in byte) of the custom field in the block header is beyond a threshold (64). If so, the block is invalid.</li><li>Check whether the height of a block is larger than the height of its parent block by 1. If NOT, the block is invalid.</li><li>Check whether the timestamp of a block is larger than or equal to the timestamp of its parent block. If NOT, the block is invalid.</li><li>Check the block gas limit is correctly set. </li><li>Check the block difficulty is correctly set.</li><li>Check whether the block header contains the correct transaction root according to the transactions in the block body.</li><li>Check whether every transaction in the block body has valid signature structure.</li><li>Check whether the total size of the transactions in the block body is larger than the block size limit (800KB). If so, the block is invalid.</li><li>Check whether the total gas limit of transactions in the block body is larger than the block gas limit. If so, the block is invalid.</li></ol><p>The validity checks 1~9 only use information in block header. The validity checks 10~13 use the information in block body. The checks 6~9 require graph structure information like parent information and are conducted on a block when the headers of all its past blocks have entered the synchronization graph. To speed up the block relay process, when both the header and body of a block have entered the synchronization graph and the headers of all its past blocks have also entered, the block can be relayed to the peers. It is not needed to wait for the bodies of all the past blocks of a block to be received in order to relay the block. This may lead to relaying invalid blocks, but since all the relayed blocks already have valid difficulty and POW settings, the attackers who make this case also pay the corresponding cost of computation power. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="graph-structure-maintenance"></a>Graph Structure Maintenance<a class="hash-link" href="#graph-structure-maintenance" title="Direct link to heading">#</a></h3><p>The node structure of synchronization graph is defined as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">SynchronizationGraphNode</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub block_header</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> Arc</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">BlockHeader</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The status of graph connectivity in the current block view.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub graph_status</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> u8</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Whether the block body is ready.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub block_ready</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Whether parent is in old era and already reclaimed</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub parent_reclaimed</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The index of the parent of the block.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub parent</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> usize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The indices of the children of the block.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub children</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">usize</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The indices of the blocks referenced by the block.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub referees</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">usize</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The number of blocks referenced by the block but</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// haven&#x27;t been inserted in synchronization graph.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub pending_referee_count</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> usize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The indices of the blocks referencing the block.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub referrers</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">usize</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// the timestamp in seconds when graph_status updated</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub last_update_timestamp</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> u64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The graph structure is maintained by the fields <code>parent</code>, <code>children</code>, <code>referees</code>, and <code>referrers</code>. Each node has a <code>graph_status</code> field representing its status changing during the period from the time when the header arrives to the time when the block is ready to be dispatched to consensus graph. </p><p>When a block header enters synchronization graph, it is first checked whether this block is already processed by synchronization graph.
If not, it will be added into the graph and the graph structure will be updated accordingly.
First, the <em>parent/children</em> edge will be established.
If the parent of this newly arrived block hasnâ€™t come into synchronization graph, the graph uses a collection <code>children_by_hash</code> to handle this.
This is a map from block hash to a set of graph nodes.
In this case, the graph node representing this newly arrived block header will be added into the graph node set mapped from the parent block hash of this block.
This functions as a bookkeeping to remember the relation between the parent block hash and this newly arrived block.
Once this parent block comes into the synchronization graph in the future, the corresponding edge between the parent and child nodes can be established and the hash of the parent block will be removed from the <code>children_by_hash</code> map.
Secondly, the <em>referees/referrers</em> edges will also be established.
Similarly, the synchronization graph uses a map <code>referrers_by_hash</code> to remember the relation between the unarrived referee block and the newly arrived referrer block.
The graph node also maintains a <code>pending_referee_count</code> field to remember how many referees of the block havenâ€™t come into the synchronization graph.</p><p>A graph node may be in the following 5 status:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><div tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// This block is an invalid block.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> BLOCK_INVALID</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> u8 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Just get the header of the block.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> BLOCK_HEADER_ONLY</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> u8 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The headers of all the blocks in the past set of this block have already entered</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// synchronization graph. </span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> BLOCK_HEADER_GRAPH_READY</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> u8 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Both the headers and bodies of all the blocks in the past set of this block have</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// entered synchronization graph.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> BLOCK_GRAPH_READY</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> u8 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>When a block header just enters the synchronization graph and triggers a new graph node being created and added in the graph, the initial status of the node is <code>BLOCK_HEADER_ONLY</code>.
And according to this graph structure update, the status of other nodes in the graph may also change.
The effects of these changes are fulfilled by conducting a BFS traversal from the node to all its descendants.
During this traversal process, for each node,
1) if it is invalid, all its descendants are invalid;
2) if it is new to be <code>BLOCK_HEADER_GRAPH_READY</code>, some graph-related validity checks (6~9) are applied on it.
If it passes these checks, it is then checked whether its block body has already entered synchronization graph (by checking the <code>block_ready</code> field of the graph node).
If so, this block is ready to be relayed. And this block may make some of its descendants become <code>BLOCK_HEADER_GRAPH_READY</code>.
Note that this cannot make its descendants become <code>BLOCK_GRAPH_READY</code> since the original node (at the starting point of the BFS process) for the newly arrived block header can only be <code>BLOCK_HEADER_GRAPH_READY</code>; </p><p>When a block body just enters the synchronization graph, the corresponding graph node should already exist in synchronization graph, otherwise, the block will be ignored (this may happen if it is garbage collected).
The <code>block_ready</code> field of this node will be set as true now.
The block then goes through the corresponding validity checks (10~13).
And similarly, this newly arrived block body will change the status of some of its descendants.
This is also done by conducting a BFS traversal from this node.
During this traversal process, for each node,
1) if it is invalid, all its descendants are invalid;
2) if it is new to be <code>BLOCK_GRAPH_READY</code>, it is dispatched to consensus graph.
It may make some of its descendants become <code>BLOCK_GRAPH_READY</code>.
If the block with the newly arrived body is at least <code>BLOCK_HEADER_GRAPH_READY</code>, it becomes ready to be relayed.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="garbage-collect-dangling-blocks"></a>Garbage Collect Dangling Blocks<a class="hash-link" href="#garbage-collect-dangling-blocks" title="Direct link to heading">#</a></h3><p>Some (adversarial) nodes may send to a full node some blocks that cannot be in status of <code>BLOCK_GRAPH_READY</code> forever, e.g., to conduct DDOS attack or to be in the case of serious message delay so that the block does not belong to the current checkpoint era anymore.
These blocks will be held in synchronization graph but should be garbage-collected eventually to avoid wasting memory resources.
In order to do this, the synchronization graph maintains a set of blocks representing the frontier of these graph-unready blocks.
A block should be a frontier block if
1) the block is not in status of <code>BLOCK_GRAPH_READY</code> but its parent block is; or
2) its parent block has not come into the synchronization graph. </p><p>To garbage collect these graph-unready blocks, it starts from the frontier of these blocks, and removes them and all their descendants that can be reached through BFS traversal by following children and referrers edges.
The reason that we must remove all the descendants of the frontier blocks from the synchronization graph is related to the design of block synchronization process.
During the block synchronization, it follows the parent and referees edges of a newly arrived block and tries to fetch the missing ancestors.
When it encounters such an ancestor block that already exists in synchronization graph, the process stops following its parent and referees edges further.
Therefore, if the ancestor block is the descendant block of some frontier graph-unready block that has already been garbage collected, this removed unready block will never get chance to be fetched from peer again.
However, this removed frontier block may be graph-unready merely because a temporary bad network situation which may recover later.</p><p>This garbage collection process is triggered periodically, and in each of this process, it only tries to remove frontier blocks and their descendants which have already been in unready status for a long time.
In order to get the timing information, each graph node has a field <code>last_update_timestamp</code> to remember the timestamp of the last update of the node status.</p><p>One optimization in the synchronization process is that it does not always fetch from peers the parent and referees of newly arrived block that are missing in memory.
It checks whether the height of the block is far less than the height of the local best epoch block.
If so, it is highly probable that the ancestors of this block exist in local database, so it deserves the effort of trying to get these blocks from local database first.
It is also an effective way to avoid unnecessary backward tree-graph traversing merely according to the peer information, which we also cover a bit more detail in <a href="/conflux-doc/docs/recovery">Recovery Process</a> section.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/conflux-doc/docs/sync.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#graph-structure-maintenance" class="table-of-contents__link">Graph Structure Maintenance</a></li><li><a href="#garbage-collect-dangling-blocks" class="table-of-contents__link">Garbage Collect Dangling Blocks</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Overview</a></li><li class="footer__item"><a href="https://fluentwallet.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Fluent Wallet</a></li><li class="footer__item"><a href="https://confluxscan.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Conflux Scan</a></li><li class="footer__item"><a href="http://faucet.confluxnetwork.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Testnet Faucet</a></li><li class="footer__item"><a href="https://evm.fluentwallet.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Space Bridge</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Tools</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.obsidians.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Conflux studio</a></li><li class="footer__item"><a href="https://chainide.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">ChainIDE</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://bountyv2.confluxnetwork.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bounty</a></li><li class="footer__item"><a href="https://forum.conflux.fun/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum</a></li><li class="footer__item"><a href="https://discord.com/invite/aCZkf2C" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/Conflux-Chain" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/Conflux_Network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://medium.com/@ConfluxNetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Â© 2022 Conflux. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/styles.09d29aa9.js"></script>
<script src="/assets/js/runtime~main.fc3fe743.js"></script>
<script src="/assets/js/main.048bb938.js"></script>
<script src="/assets/js/1.d3ce46d4.js"></script>
<script src="/assets/js/2.7790b6fc.js"></script>
<script src="/assets/js/3.8961ff1e.js"></script>
<script src="/assets/js/1be78505.764ef7d8.js"></script>
<script src="/assets/js/114.2bb3ed4e.js"></script>
<script src="/assets/js/935f2afb.100b377e.js"></script>
<script src="/assets/js/17896441.5fa3fe54.js"></script>
<script src="/assets/js/9296fd2d.f66c1b88.js"></script>
</body>
</html>